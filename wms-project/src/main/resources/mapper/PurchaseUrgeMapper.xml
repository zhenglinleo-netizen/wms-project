<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.wms.mapper.PurchaseUrgeMapper">
    
    <resultMap id="BaseResultMap" type="com.example.wms.entity.PurchaseUrge">
        <id column="id" property="id"/>
        <result column="order_id" property="orderId"/>
        <result column="user_id" property="userId"/>
        <result column="urge_content" property="urgeContent"/>
        <result column="response_content" property="responseContent"/>
        <result column="status" property="status"/>
        <result column="urge_time" property="urgeTime"/>
        <result column="response_time" property="responseTime"/>
        <result column="user_name" property="userName"/>
        <result column="order_code" property="orderCode"/>
    </resultMap>
    
    <select id="selectById" resultMap="BaseResultMap">
        SELECT pu.*, u.real_name as user_name, po.order_code
        FROM purchase_urge pu
        LEFT JOIN sys_user u ON pu.user_id = u.id
        LEFT JOIN purchase_order po ON pu.order_id = po.id
        WHERE pu.id = #{id}
    </select>
    
    <select id="selectByOrderId" resultMap="BaseResultMap">
        SELECT pu.*, u.real_name as user_name, po.order_code
        FROM purchase_urge pu
        LEFT JOIN sys_user u ON pu.user_id = u.id
        LEFT JOIN purchase_order po ON pu.order_id = po.id
        WHERE pu.order_id = #{orderId}
        ORDER BY pu.urge_time DESC
    </select>
    
    <select id="selectPendingByOrderId" resultMap="BaseResultMap">
        SELECT pu.*, u.real_name as user_name, po.order_code
        FROM purchase_urge pu
        LEFT JOIN sys_user u ON pu.user_id = u.id
        LEFT JOIN purchase_order po ON pu.order_id = po.id
        WHERE pu.order_id = #{orderId} AND pu.status = 'pending'
        ORDER BY pu.urge_time DESC
    </select>
    
    <select id="selectList" resultMap="BaseResultMap">
        SELECT pu.*, u.real_name as user_name, po.order_code
        FROM purchase_urge pu
        LEFT JOIN sys_user u ON pu.user_id = u.id
        LEFT JOIN purchase_order po ON pu.order_id = po.id
        WHERE 1=1
        <if test="orderId != null">
            AND pu.order_id = #{orderId}
        </if>
        <if test="userId != null">
            AND pu.user_id = #{userId}
        </if>
        <if test="status != null and status != ''">
            AND pu.status = #{status}
        </if>
        ORDER BY pu.urge_time DESC
    </select>
    
    <insert id="insert" parameterType="com.example.wms.entity.PurchaseUrge" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO purchase_urge (order_id, user_id, urge_content, status, urge_time)
        VALUES (#{orderId}, #{userId}, #{urgeContent}, #{status}, #{urgeTime})
    </insert>
    
    <update id="updateById" parameterType="com.example.wms.entity.PurchaseUrge">
        UPDATE purchase_urge
        <set>
            <if test="responseContent != null">response_content = #{responseContent},</if>
            <if test="status != null">status = #{status},</if>
            <if test="responseTime != null">response_time = #{responseTime},</if>
        </set>
        WHERE id = #{id}
    </update>
    
    <update id="updateResponse">
        UPDATE purchase_urge 
        SET response_content = #{responseContent}, 
            status = #{status},
            response_time = NOW()
        WHERE id = #{id}
    </update>
    
    <delete id="deleteById">
        DELETE FROM purchase_urge WHERE id = #{id}
    </delete>
    
</mapper>
